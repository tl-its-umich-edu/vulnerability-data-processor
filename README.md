# vulnerability-data-processor
Programs for processing vulnerability data, in Grafeas-formatted YAML, into convenient reports.

This project was developed to process project vulnerability data provided by Unizin.  The resulting report, in TSV, is used to create issues in the projects for resolving the vulnerabilities.

## Selecting a technology

Initially, this project was prototyped using a pipeline of `yq` to convert YAML to JSON, followed by `jq` to extract the necessary JSON data elements, and storing them as TSV.  However, `jq`'s syntax is rather terse and easy to get wrong.  Switching to a `yq`-only solution was considered, but it would probably also be a steep learning curve.  Then the idea of an XPath-like solution for accessing YAML came up and [`yamlpath`](https://github.com/wwkimball/yamlpath) was noticed.

After the `yamlpath` was selected as the ideal technology for this processor and the program was completed, it was learned that the vulnerability data in the YAML data was in the Grafeas format.  Python modules for working with Grafeas were found, but it was unclear whether they were for producing or consuming the data.  Also unclear was whether the processor should be rewritten again using those modules. 

## Learning YAML path syntax
Some of the benefits of using the `yamlpath` module are the CLI tools it provides.  That made understanding the syntax of YAML path strings easier and finding the YAML path to specific values.

For example, the following shows how `yamlpath` CLI tools were used to find the paths to specific values and learn about the structure of the dataâ€¦

```shell
# list YAML paths to any values containing "app_name"
yaml-paths --search=%app_name vulnerabilities.yaml

# get YAML path to a specific value (image tag)
yaml-paths --search=%2022.01.01 vulnerabilities.yaml

# get a specific value, e.g., the app image tag
yaml-get --query=image_summary.tag vulnerabilities.yaml

# get all the vulnerability objects
yaml-get -p package_vulnerability_summary.vulnerabilities.\*.\* vulnerabilities.yaml
```

Although the documentation explains how `.*.*` works, in this application it was used instinctively.  XPath (and probably JSONPath) has a similar syntax and it was remembered for this occasion.

## Using the `yamlpath` Python module

There was an issue in the `yamlpath` GitHub repo requesting improved, more explicit documentation of using the module.  The author seemed unhappy with the suggestion and stated that much has been documented and the code is self-documenting.  While that is somewhat true, it's not a very welcoming approach if getting others to use the module is desired.

So, while implementing this processor, it was helpful to examine the code for [yaml_get.py](https://github.com/wwkimball/yamlpath/blob/master/yamlpath/commands/yaml_get.py).  There it was learned that each node returned by `processor.get_nodes()` needed to be "unwrapped" using `NodeCoords.unwrap_node_coords(node)` in order to get to the useful data.  That was **_not_** explained in the documentation.  Adding this to the example code in the `yamlpath` README would've reduced the development time by a couple of hours.
